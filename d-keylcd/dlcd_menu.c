#include <stdio.h>
#include <unistd.h>

#include "lib_fpga.h"

#include "addr.h"
#include "dlcd_global.h"
#include "dlcd_ctrl.h"
#include "dlcd_menu.h"

const u8_t ascii_6_8[][6] = {

/*
* delta = SPCACE(0x20)
*/
0x00, 0x00, 0x00, 0x00, 0x00, 0x00,// SPACE
0x00, 0x00, 0x4f, 0x00, 0x00, 0x00,// !
0x00, 0x07, 0x00, 0x07, 0x00, 0x00,// "
0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00,// #
0x24, 0x2a, 0x7f, 0x2a, 0x12, 0x00,// $
0x23, 0x13, 0x08, 0x64, 0x62, 0x00,// %
0x36, 0x49, 0x55, 0x22, 0x50, 0x00,// &
0x00, 0x05, 0x03, 0x00, 0x00, 0x00,// '
0x00, 0x1c, 0x22, 0x41, 0x00, 0x00,// (
0x00, 0x41, 0x22, 0x1c, 0x00, 0x00,// )
0x14, 0x08, 0x3e, 0x08, 0x14, 0x00,// *
0x08, 0x08, 0x3e, 0x08, 0x08, 0x00,// +
0x00, 0x50, 0x30, 0x00, 0x00, 0x00,// ,
0x08, 0x08, 0x08, 0x08, 0x08, 0x00,// -
0x00, 0x60, 0x60, 0x00, 0x00, 0x00,// .
0x20, 0x10, 0x08, 0x04, 0x02, 0x00,// /
0x3e, 0x51, 0x49, 0x45, 0x3e, 0x00,// 0
0x00, 0x42, 0x7f, 0x40, 0x00, 0x00,// 1
0x42, 0x61, 0x51, 0x49, 0x46, 0x00,// 2
0x21, 0x41, 0x45, 0x4b, 0x31, 0x00,// 3
0x18, 0x14, 0x12, 0x7f, 0x10, 0x00,// 4
0x27, 0x45, 0x45, 0x45, 0x39, 0x00,// 5
0x3c, 0x4a, 0x49, 0x49, 0x30, 0x00,// 6
0x01, 0x71, 0x09, 0x05, 0x03, 0x00,// 7
0x36, 0x49, 0x49, 0x49, 0x36, 0x00,// 8
0x06, 0x49, 0x49, 0x29, 0x1e, 0x00,// 9
0x00, 0x36, 0x36, 0x00, 0x00, 0x00,// :
0x00, 0x56, 0x36, 0x00, 0x00, 0x00,// ;
0x08, 0x14, 0x22, 0x41, 0x00, 0x00,// <
0x14, 0x14, 0x14, 0x14, 0x14, 0x00,// =
0x00, 0x41, 0x22, 0x14, 0x08, 0x00,// >
0x02, 0x01, 0x51, 0x09, 0x06, 0x00,// ?
0x32, 0x49, 0x79, 0x41, 0x3e, 0x00,// @
0x7e, 0x11, 0x11, 0x11, 0x7e, 0x00,// A
0x7f, 0x49, 0x49, 0x49, 0x36, 0x00,// B
0x3e, 0x41, 0x41, 0x41, 0x22, 0x00,// C
0x7f, 0x41, 0x41, 0x22, 0x1c, 0x00,// D
0x7f, 0x49, 0x49, 0x49, 0x41, 0x00,// E
0x7f, 0x09, 0x09, 0x09, 0x01, 0x00,// F
0x3e, 0x41, 0x49, 0x49, 0x7a, 0x00,// G
0x7f, 0x08, 0x08, 0x08, 0x7f, 0x00,// H
0x00, 0x41, 0x7f, 0x41, 0x00, 0x00,// I
0x20, 0x40, 0x41, 0x3f, 0x01, 0x00,// J
0x7f, 0x08, 0x14, 0x22, 0x41, 0x00,// K
0x7f, 0x40, 0x40, 0x40, 0x40, 0x00,// L
0x7f, 0x02, 0x0c, 0x02, 0x7f, 0x00,// M
0x7f, 0x04, 0x08, 0x10, 0x7f, 0x00,// N
0x3e, 0x41, 0x41, 0x41, 0x3e, 0x00,// O
0x7f, 0x09, 0x09, 0x09, 0x06, 0x00,// P
0x3e, 0x41, 0x51, 0x21, 0x5e, 0x00,// Q
0x7f, 0x09, 0x19, 0x29, 0x46, 0x00,// R
0x46, 0x49, 0x49, 0x49, 0x31, 0x00,// S
0x01, 0x01, 0x7f, 0x01, 0x01, 0x00,// T
0x3f, 0x40, 0x40, 0x40, 0x3f, 0x00,// U
0x1f, 0x20, 0x40, 0x20, 0x1f, 0x00,// V
0x3f, 0x40, 0x38, 0x40, 0x3f, 0x00,// W
0x63, 0x14, 0x08, 0x14, 0x63, 0x00,// X
0x07, 0x08, 0x70, 0x08, 0x07, 0x00,// Y
0x61, 0x51, 0x49, 0x45, 0x43, 0x00,// Z
0x00, 0x7f, 0x41, 0x41, 0x00, 0x00,// [
0x02, 0x04, 0x08, 0x10, 0x20, 0x00,//
0x00, 0x41, 0x41, 0x7f, 0x00, 0x00,// ]
0x04, 0x02, 0x01, 0x02, 0x04, 0x00,// ^
0x40, 0x40, 0x40, 0x40, 0x40, 0x00,// _
0x00, 0x01, 0x02, 0x04, 0x00, 0x00,// `
0x20, 0x54, 0x54, 0x54, 0x78, 0x00,// a
0x7f, 0x48, 0x44, 0x44, 0x38, 0x00,// b
0x38, 0x44, 0x44, 0x44, 0x20, 0x00,// c
0x38, 0x44, 0x44, 0x48, 0x7f, 0x00,// d
0x38, 0x54, 0x54, 0x54, 0x18, 0x00,// e
0x08, 0x7e, 0x09, 0x01, 0x02, 0x00,// f
0x0c, 0x52, 0x52, 0x52, 0x3e, 0x00,// g
0x7f, 0x08, 0x04, 0x04, 0x78, 0x00,// h
0x00, 0x44, 0x7d, 0x40, 0x00, 0x00,// i
0x20, 0x40, 0x44, 0x3d, 0x00, 0x00,// j
0x7f, 0x10, 0x28, 0x44, 0x00, 0x00,// k
0x00, 0x41, 0x7f, 0x40, 0x00, 0x00,// l
0x7c, 0x04, 0x18, 0x04, 0x78, 0x00,// m
0x7c, 0x08, 0x04, 0x04, 0x78, 0x00,// n
0x38, 0x44, 0x44, 0x44, 0x38, 0x00,// o
0x7c, 0x14, 0x14, 0x14, 0x08, 0x00,// p
0x08, 0x14, 0x14, 0x18, 0x7c, 0x00,// q
0x7c, 0x08, 0x04, 0x04, 0x08, 0x00,// r
0x48, 0x54, 0x54, 0x54, 0x20, 0x00,// s
0x04, 0x3f, 0x44, 0x40, 0x20, 0x00,// t
0x3c, 0x40, 0x40, 0x20, 0x7c, 0x00,// u
0x1c, 0x20, 0x40, 0x20, 0x1c, 0x00,// v
0x3c, 0x40, 0x30, 0x40, 0x3c, 0x00,// w
0x44, 0x28, 0x10, 0x28, 0x44, 0x00,// x
0x0c, 0x50, 0x50, 0x50, 0x3c, 0x00,// y
0x44, 0x64, 0x54, 0x4c, 0x44, 0x00,// z
0x00, 0x08, 0x36, 0x41, 0x00, 0x00,// {
0x00, 0x00, 0x7f, 0x00, 0x00, 0x00,// |
0x00, 0x41, 0x36, 0x08, 0x00, 0x00,// }
0x08, 0x04, 0x08, 0x10, 0x08, 0x00,// ~

/*
* Index = 0x5f
*/
0x08, 0x08, 0x2a, 0x1c, 0x08, 0x00,// ->                [0x5f]
0x08, 0x1c, 0x2a, 0x08, 0x08, 0x00,// <-                [0x60]
0x04, 0x02, 0x7f, 0x02, 0x04, 0x00,// ↑                [0x61]
0x10, 0x20, 0x7f, 0x20, 0x10, 0x00,// ↓                [0x62]
0x15, 0x16, 0x7c, 0x16, 0x15, 0x00,// ￥                [0x63]
0x03, 0x3b, 0x44, 0x44, 0x44, 0x00,// ℃                [0x64]
0x03, 0x03, 0x7c, 0x14, 0x14, 0x00,// ℉                [0x65]
0x44, 0x28, 0x10, 0x28, 0x44, 0x00,// ×                [0x66]
0x08, 0x08, 0x2a, 0x08, 0x08, 0x00,// ÷                [0x67]
0x38, 0x44, 0x48, 0x30, 0x2c, 0x00,// α         [0x68]
0xf8, 0x54, 0x54, 0x54, 0x28, 0x00,// β                [0x69]
0x28, 0x54, 0x54, 0x44, 0x20, 0x00,// ε                [0x6a]
0x3e, 0x49, 0x09, 0x09, 0x06, 0x00,// ρ                [0x6b]
0x38, 0x44, 0x4c, 0x54, 0x24, 0x00,// σ                [0x6c]
0x40, 0x3f, 0x08, 0x08, 0x1f, 0x00,// μ                [0x6d]
0x1f, 0x08, 0x08, 0x3f, 0x40, 0x00,// η                [0x6e]
0x3c, 0x4a, 0x4a, 0x4a, 0x3c, 0x00,// θ                [0x6f]
0x58, 0x64, 0x04, 0x64, 0x58, 0x00,// Ω                [0x70]
0x44, 0x3c, 0x04, 0x7c, 0x44, 0x00,// π                [0x71]
0x30, 0x28, 0x10, 0x28, 0x18, 0x00,// ∞                [0x72]
0x30, 0x28, 0x24, 0x28, 0x30, 0x00,// △                [0x73]
0x08, 0x1c, 0x08, 0x08, 0x0e, 0x00,// Enter<-[0x74]
};

/**************************************************
author:   Tim
date:      2013.07.02
function: Transfer LCD control commad (one byte)
retrun:    NULL
modify:  
***************************************************/
void TransferCommad(u16_t line, u16_t offset, u16_t data)
{
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_ADDR, (line*132+offset));
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_DATA,  data);
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WE, 0x01);
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WE, 0x00);	
}


/**************************************************
author:   Tim
date:      2013.07.02
function: Transfer LCD data (one byte)
retrun:    NULL
modify:  
***************************************************/
void TransferData(u16_t line, u16_t offset, u16_t data)
{
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_ADDR, (line*132+0x04+offset));
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_DATA, (0x100|(data&0xFF)));
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WE, 0x01);
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WE, 0x00);
	
}


/**************************************************
author:   Tim
date:      2013.07.02
function: LCD one line begin 
retrun:    NULL
modify:  
***************************************************/
void OneLineBegin(char line)
{
	TransferCommad(line,0,0xA6);
	TransferCommad(line,1,0xB0+line);
	TransferCommad(line,2,0x10);
	TransferCommad(line,3,0x00);
}

/**************************************************
author:   Tim
date:      2013.07.02
function: LCD draw one string
retrun:    NULL
modify:  
***************************************************/
void DrawOneString(char *str,int line) 
{
    int index;
	int i = 0,j = 0;
    u8_t c;
    OneLineBegin(line);
    while((*str != 0) && (i < LCD_DOT_X))
	{
        c = *str;
        index = c - ' ';
        str ++;

		for(j = 0; j < LCD_FONT_X; j++)
	    		TransferData(line,i+j,ascii_6_8[index][j]);
		
		i += LCD_FONT_X;
    }
}

/**************************************************
author:   Tim
date:      2013.07.02
function: LCD send data end
retrun:    NULL
modify:  
***************************************************/
void FullScreenEnd()
{
#if 0
	usleep(20);
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WE, 0x00);
#else
	//wirite finish
	usleep(200);
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WREADY, 0x01);
	FpgaWrite(gLcdCtx.fpga_fd, FPGA_LCD_WREADY, 0x00);
	usleep(200);
#endif
}

/**************************************************
author:   Tim
date:      2013.07.02
function: LCD screen clean
retrun:    NULL
modify:  
***************************************************/
void FullScreenClear(void)
{
	unsigned char i,j;
	for(i=0;i<LCD_LINE;i++)
	{
		OneLineBegin(i);
		for(j=0;j<LCD_DOT_X;j++)
		{
	    	TransferData(i,j,0x00);
		}
	}
	FullScreenEnd();
}


/**************************************************
author:   Tim
date:      2013.07.02
function: LCD show menu change
retrun:    NULL
modify:  
***************************************************/

void ShowMenuChange(char line)
{
	int index;
	int i,j;
	for(i=0;i<LCD_LINE;i++)
	{
		OneLineBegin(i);
		index = ' ' - ' ';
		for(j=0;j<LCD_FONT_X;j++)
			TransferData(i,j,ascii_6_8[index][j]);
	}
	OneLineBegin(line);
	index = '*' - ' ';
	for(j=0;j<LCD_FONT_X;j++)
		TransferData(line,j,ascii_6_8[index][j]);

	FullScreenEnd();

}


